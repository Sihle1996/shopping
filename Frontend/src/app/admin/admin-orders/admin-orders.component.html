<div class="p-4 max-w-6xl mx-auto pb-32">

  <h2 class="text-2xl font-bold mb-6 text-gray-800">ðŸ“¦ Orders Management</h2>

  <!-- Toolbar -->
  <div class="bg-white p-4 rounded-md shadow mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div class="flex items-center gap-2">
      <label class="text-sm font-medium text-gray-700">Status:</label>
      <select [(ngModel)]="filterStatus" (change)="fetchOrders(1)" class="border px-3 py-1 rounded">
        <option value="All">All</option>
        <option value="Pending">Pending</option>
        <option value="In Progress">In Progress</option>
        <option value="Delivered">Delivered</option>
      </select>
    </div>
    <input
      type="text"
      placeholder="Search orders"
      (input)="onSearch($any($event.target).value)"
      class="border px-3 py-1 rounded w-full md:w-64" />
  </div>

  <!-- Orders Table -->
  <app-table-skeleton *ngIf="loading"></app-table-skeleton>
  <div *ngIf="errorMessage" class="text-red-500">{{ errorMessage }}</div>

  <div class="table-container" *ngIf="!loading && !errorMessage">
    <table class="orders-table">
      <thead>
        <tr>
          <th (click)="setSort('id')">ID <span>{{ getSortIcon('id') }}</span></th>
          <th (click)="setSort('orderDate')">Date <span>{{ getSortIcon('orderDate') }}</span></th>
          <th (click)="setSort('userEmail')">User <span>{{ getSortIcon('userEmail') }}</span></th>
          <th (click)="setSort('totalAmount')">Total <span>{{ getSortIcon('totalAmount') }}</span></th>
          <th (click)="setSort('status')">Status <span>{{ getSortIcon('status') }}</span></th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let order of filteredOrders()">
          <td>{{ order.id }}</td>
          <td>{{ order.orderDate }}</td>
          <td>{{ order.userEmail }}</td>
          <td>R{{ order.totalAmount.toFixed(2) }}</td>
          <td>
            <select [(ngModel)]="order.status" (change)="updateStatus(order.id, order.status)"
                    class="px-2 py-1 border rounded text-sm">
              <option value="Pending">Pending</option>
              <option value="In Progress">In Progress</option>
              <option value="Delivered">Delivered</option>
            </select>
          </td>
          <td>
            <button (click)="openDrawer(order)"
                    class="px-4 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">View</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <app-pagination [currentPage]="currentPage" [totalPages]="totalPages" (pageChange)="onPageChange($event)"></app-pagination>

  <!-- Drawer -->
  <div *ngIf="selectedOrder" class="drawer">
    <div class="drawer-overlay" (click)="closeDrawer()"></div>
    <div class="drawer-panel">
      <button (click)="closeDrawer()" class="absolute top-3 right-4 text-gray-500 hover:text-black text-xl">&times;</button>
      <h3 class="text-xl font-semibold text-gray-800 mb-4">ðŸ§¾ Order Details #{{ selectedOrder.id }}</h3>

      <p><strong>Status:</strong> <span [ngClass]="getStatusColor(selectedOrder.status)">{{ selectedOrder.status }}</span></p>
      <p><strong>User Email:</strong> {{ selectedOrder.userEmail }}</p>
      <p><strong>Payment ID:</strong> {{ selectedOrder.paymentId }}</p>
      <p><strong>Delivery Address:</strong> {{ selectedOrder.deliveryAddress }}</p>

      <div class="mt-4">
        <h4 class="font-bold text-gray-700 mb-2">Ordered Items:</h4>
        <ul class="divide-y divide-gray-200">
          <li *ngFor="let item of selectedOrder.items" class="py-2">
            <div class="flex justify-between">
              <span>{{ item.name }} <span class="text-sm text-gray-500">({{ item.size }})</span></span>
              <span class="font-medium">Qty: {{ item.quantity }}</span>
            </div>
          </li>
        </ul>
      </div>

      <div class="mt-4">
        <h4 class="font-bold text-gray-700 mb-2">Assign Driver:</h4>

        <div class="flex flex-col md:flex-row items-center gap-2">
          <select [(ngModel)]="selectedDriverId" class="border px-3 py-2 rounded w-full md:w-auto">
            <option [ngValue]="null">-- Select a Driver --</option>
            <option *ngFor="let driver of availableDrivers" [ngValue]="driver.id">
              {{ driver.email }}
            </option>
          </select>

          <button
            (click)="assignDriver()"
            [disabled]="!selectedDriverId || assigning"
            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center justify-center">
            <ng-container *ngIf="!assigning; else loadingTpl">Assign</ng-container>
            <ng-template #loadingTpl>
              <app-button-spinner></app-button-spinner>
            </ng-template>
          </button>
        </div>
      </div>

    </div>
  </div>

</div>
